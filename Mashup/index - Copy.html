<!DOCTYPE html>
<html>

<head>
    <link rel="stylesheet" href="./css/style.css" type="text/css">
    <script type="text/javascript" src="./js/sha.js"></script>
</head>

<body>
    <div id="mapsDiv">

        <div style="background-color: black; " id="map">

        </div>

    </div>
    <script>
        var map;
        function initMap() {
            map = new google.maps.Map(document.getElementById('mapsDiv'), {
                center: { lat: 39.83334, lng: -98.58334 },
                gestureHandling: 'none',
                zoomControl: 'false',
                zoom: 8
            });

            let southWest = new google.maps.LatLng(24.9493, -125.0011);
            let northEast = new google.maps.LatLng(49.5904, -66.9326);
            let bounds = new google.maps.LatLngBounds(southWest, northEast);
            map.fitBounds(bounds);

            var i = 0;
            for (var city = 0; city < workingSetPos.length; city++) {
                var cityCircle = new google.maps.Circle({
                    strokeColor: '#FF0000',
                    strokeOpacity: 0.8,
                    strokeWeight: 2,
                    fillColor: '#FF0000',
                    fillOpacity: 0.35,
                    map: map,
                    center: cityInfo[workingSetPos[city]].center,
                    radius: (cityInfo[workingSetPos[city]]['city size in km']) * 100
                });
                console.log(cityInfo[workingSetPos[city]]);
                console.log(`City ${cityInfo[workingSetPos[city]].city} has ${(cityInfo[workingSetPos[city]]['city size in km']) * 100}`);
                i++;
            }
        }
    </script>
    <script>

        function NatoToKey(NatoKey) {
            key = "";
            NatoKey.forEach(element => {
                key += keyInfo[element];
            });
            return key;
        }

        const SIZEOFVALUES = 10;

        var workingSetPos = [];
        var workingSet = [];
        var workingSetPromises = [];

        var BasicHeader;

        var myHeaders;//= new Headers();

        const keyFakeGoogle = [
            "Alpha",
            "India",
            "zulu",
            "alpha",
            "Sierra",
            "yankee",
            "Delta",
            "kilo",
            "Quebec",
            "Underscore",
            "Zero",
            "Underscore",
            "Kilo",
            "hotel",
            "X-ray",
            "India",
            "victor",
            "foxtrot",
            "Whiskey",
            "Mike",
            "Sierra",
            "papa",
            "hotel",
            "Juliett",
            "echo",
            "romeo",
            "India",
            "november",
            "Victor",
            "Dash",
            "quebec",
            "mike",
            "Foxtrot",
            "Seven",
            "Zero",
            "Six",
            "Kilo",
            "Hotel",
            "India"
        ]

        const consumerKey = [
            'quebec',
            'Zulu',
            'india',
            'tango',
            'november',
            'Sierra',
            'Kilo',
            'bravo',
            'papa',
            'lima',
            'Victor',
            'Oscar',
            'Nine',
            'Oscar',
            'Uniform',
            'Sierra',
            'delta',
            'Zulu',
            'quebec',
            'Six',
            'yankee',
            'tango',
            'Delta',
            'oscar',
            'Papa']

        const consumerSecret = [
            'Alpha',
            'Uniform',
            'Charlie',
            'november',
            'lima',
            'bravo',
            'Seven',
            'Charlie',
            'Sierra',
            'Lima',
            'Sierra',
            'Victor',
            'November',
            'victor',
            'x-ray',
            'Eight',
            'bravo',
            'hotel',
            'Sierra',
            'alpha',
            'lima',
            'charlie',
            'Echo',
            'Seven',
            'whiskey',
            'Papa',
            'yankee',
            'Lima',
            'Five',
            'Yankee',
            'Charlie',
            'Yankee',
            'Four',
            'delta',
            'Eight',
            'delta',
            'Tango',
            'lima',
            'whiskey',
            'whiskey',
            'november',
            'Zero',
            'whiskey',
            'alpha',
            'Seven',
            'sierra',
            'zulu',
            'One',
            'delta',
            'delta']

        const accessToken = [
            'Seven',
            'Three',
            'Eight',
            'Five',
            'Three',
            'Five',
            'Two',
            'Zero',
            'Six',
            'One',
            'Nine',
            'Zero',
            'Two',
            'One',
            'One',
            'Zero',
            'Seven',
            'Two',
            'Dash',
            'hotel',
            'Zulu',
            'whiskey',
            'Five',
            'Zero',
            'bravo',
            'delta',
            'oscar',
            'Sierra',
            'whiskey',
            'Echo',
            'Yankee',
            'alpha',
            'Mike',
            'india',
            'india',
            'sierra',
            'delta',
            'delta',
            'Uniform',
            'papa',
            'papa',
            'Yankee',
            'echo',
            'Seven',
            'whiskey',
            'Six',
            'whiskey',
            'Papa',
            'mike',
            'Alpha']

        const tokenSecret = [
            'One',
            'One',
            'Zulu',
            'Foxtrot',
            'Lima',
            'hotel',
            'Alpha',
            'Eight',
            'uniform',
            'whiskey',
            'Hotel',
            'Kilo',
            'romeo',
            'alpha',
            'Sierra',
            'Papa',
            'Alpha',
            'papa',
            'Uniform',
            'whiskey',
            'november',
            'Mike',
            'hotel',
            'kilo',
            'alpha',
            'Echo',
            'juliett',
            'lima',
            'mike',
            'lima',
            'Tango',
            'Nine',
            'romeo',
            'Alpha',
            'oscar',
            'November',
            'Zulu',
            'quebec',
            'One',
            'yankee',
            'Seven',
            'foxtrot',
            'Papa',
            'foxtrot',
            'Zero']

        var randomString = function (length) {
            var text = "";
            var possible = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
            for (var i = 0; i < length; i++) {
                text += possible.charAt(Math.floor(Math.random() * possible.length));
            }
            return text;
        }

        var cityInfo;
        var keyInfo;
        fetch('./data/dat.json').then(
            response => {
                console.log(response);
                response.json().then(
                    data => {
                        cityInfo = data;
                    }).then(() => {
                        fetch('./data/keyMap.json').then(
                            response => {
                                console.log(response);
                                response.json().then(
                                    data => {
                                        keyInfo = data;
                                        BasicHeader = `oauth_consumer_key=${NatoToKey(consumerKey)}&oauth_nonce=${randomString(16)}&oauth_signature_method=${'HMAC-SHA1'}&oauth_timestamp=${Date.now()}&oauth_token=${NatoToKey(accessToken)}&oauth_version=1.0`;
                                        let text = 'OAuth ' + BasicHeader + `&oauth_signature=${escape(calcHMAC(BasicHeader))}`;
                                        //text.replace(/.*&.*/g, /,/g);
                                        text = (text.split('&')).join(',');
                                        myHeaders = new Headers({ 'Authorization': text });
                                        console.log(myHeaders.get('Authorization'));
                                    }
                                ).then(
                                    () => {
                                        while (workingSetPos.length < SIZEOFVALUES) {
                                            let temp = Math.floor(Math.random() * cityInfo.length);
                                            if (!workingSetPos.includes(temp)) {
                                                workingSetPos.push(temp);
                                            } else {
                                                continue;
                                            }
                                        }
                                    }).then(
                                        () => {
                                            for (let temp = 0; temp < 1/*workingSetPos.length*/; temp++) {
                                                let address =
                                                    workingSetPromises.push(fetch(`https://api.twitter.com/1.1/search/tweets.json?q=${"The Outer Worlds"}`/*&geocode=${cityInfo[temp].center.lat, cityInfo[temp].center.lng, Math.sqrt(cityInfo[temp]["city size in km"])}&since=${(new Date() - 1)}&result_type=recent&count=100`*/, {
                                                        method: 'GET',
                                                        mode: 'no-cors',
                                                        headers: myHeaders
                                                    }).then(
                                                        () => {
                                                            console.log(response);
                                                            response.json().then(
                                                                () => {
                                                                    workingSet.push({
                                                                        "center": {
                                                                            "lat": cityInfo[workingSetPos[temp]].center.lat,
                                                                            "lng": cityInfo[workingSetPos[temp]].center.lng
                                                                        },
                                                                        "city": cityInfo[workingSetPos[temp]].city,
                                                                        "city size in km": cityInfo[workingSetPos[temp]]["city size in km"]
                                                                    })
                                                                }
                                                            )
                                                        }
                                                    ));
                                            }
                                            Promise.all().then(
                                                () => {
                                                    let createScript = document.createElement('script');
                                                    createScript.src = `https://maps.googleapis.com/maps/api/js?key=${
                                                        NatoToKey(keyFakeGoogle)}&callback=initMap`;
                                                    createScript.defer = true;
                                                    document.body.insertAdjacentElement("beforeend", createScript);
                                                },
                                                () => {
                                                    console.log("Error while parsing map");
                                                })
                                        })
                            })
                    },
                        () => {
                            console.log("Error while parsing key information file");
                        }
                    )
            },
            () => {
                console.log("Error while parsing city information file");
            }
        );

    </script>
    <script>
        function calcHMAC(text) {
            try {
                //var time = Date().now();

                var hmacText = `GET&${escape("https://api.twitter.com/1.1/search/tweets.json&")}&` + escape(text);

                console.log(hmacText);
                var hmacTextType = "TEXT";
                var hmacKeyInput = `${NatoToKey(consumerSecret)}&${NatoToKey(tokenSecret)}`;
                var hmacKeyInputType = "TEXT";
                var hmacVariant = "SHA-1";
                var hmacOutputType = "B64";
                var hmacObj = new jsSHA(
                    hmacVariant,
                    hmacTextType
                );
                hmacObj.setHMACKey(
                    hmacKeyInput,
                    hmacKeyInputType
                );
                hmacObj.update(hmacText);

                console.log(hmacObj.getHMAC(hmacOutputType));

                return hmacObj.getHMAC(hmacOutputType);

            } catch (e) {
                console.log(e.message);
                return e.message;
            }
        }
    </script>

</body>

</html>